<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Starlight Touch - å¿ƒå‹•å¬å–šæ©Ÿ</title>
  <style>
    body {
      font-family: "æ¨™æ¥·é«”", "DFKai-SB", Arial, sans-serif;
      margin: 0;
      background: linear-gradient(to right, #ebf1ff, #c1d2f7);
      color: #333;
      text-align: center;
    }
    header {
      background-color: #41537a;
      color: white;
      padding: 1rem;
      font-size: 1.8rem;
    }
    #card-container {
      margin-top: 2rem;
      width: 300px;
      height: 400px;
      margin-left: auto;
      margin-right: auto;
      border: 8px solid white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
      background-size: cover;
      background-position: center;
      transition: background-image 0.3s ease-in-out;
    }
    #idol-caption {
      margin-top: 1rem;
      font-size: 1.3rem;
      color: #5a70bf;
      font-weight: bold;
      min-height: 2em;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      border: none;
      background-color: #41537a;
      color: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #6a7fad;
    }
    #webcam {
      display: none;
    }
    #videoCanvas {
      display: none;
    }
  </style>
</head>
<body>

<header>ğŸŒŸ Starlight Touchï¼å¿ƒå‹•å¬å–šæ©Ÿ ğŸŒŸ</header>

<div id="collection-section" class="mt-8">
  <!-- æ”¹æˆç›´æ¥è·³è½‰ï¼Œä¸å¸¶onclick -->
  <a href="collection.html">
    <button>æ‰“é–‹æˆ‘çš„æ”¶é›†å†Š</button>
  </a>

  <div id="card-container" style="background-image: url('/static/cards/normal/è®š1.jpeg');"></div>
  <div id="idol-caption">ä½ ä»Šå¤©æƒ³æŠ½åˆ°èª°ï¼</div>
  <button id="summon-btn">âœ¨ é»æˆ‘å¬å–šå°å¡ âœ¨</button>
</div>

<video id="webcam" autoplay playsinline width="640" height="480"></video>
<canvas id="videoCanvas" width="640" height="480"></canvas>

<audio id="sound" preload="auto"></audio>

<!-- MediaPipe Hands -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<!-- Teachable Machine Image -->
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script>
  // å¡ç‰‡è³‡æ–™
  const cardData = {
    normal: [
      { image: 'è®š1.jpeg', caption: 'è·Ÿè‘—ç¢©å’ªç¬‘ä¸€å€‹ï¼' },
      { image: 'è®š2.jpeg', caption: 'ä»Šå¤©ä¹Ÿè¦é–‹å¿ƒå”·ï¼' },
      { image: 'è®š3.jpeg', caption: 'Keep shining, my starï¼' },
      { image: 'è®š4.jpeg', caption: 'ç¬‘ä¸€å€‹å­ï¼' },
      { image: 'è®š5.jpeg', caption: 'è·Ÿè‘—å°é¶´ç¬‘ä¸€å€‹ï¼' },
      { image: 'è®š6.jpeg', caption: 'å¸¥å“¥ç¥æ³¥æœ‰ç¾å¥½çš„ä¸€å¤©ï¼' },
      { image: 'è®š7.jpeg', caption: 'æ¯å¤©éƒ½è¦å¹¸ç¦ï¼' },
      { image: 'è®š8.jpeg', caption: 'è·Ÿæˆ‘ä¸€èµ·é–ƒé–ƒç™¼å…‰ğŸ’ï¼' },
      { image: 'è®š9.jpeg', caption: 'èŒèŒå°å­©ä¾†æ‰¾åª½å’ªå•¦' },
      { image: 'è®š10.jpeg', caption: 'æœ‰ä½ çœŸå¥½ï½ï½ğŸ’Œ' },
      { image: 'è®š11.jpeg', caption: 'say cheeseï¼' },
      { image: 'è®š12.jpeg', caption: 'éƒ½è¦å¹¸ç¦ï¼' },
      { image: 'è®š13.jpeg', caption: 'å¯¶å¯¶æˆ‘ä¹Ÿå–œæ­¡ä½ ï¼' },
      { image: 'è®š14.jpeg', caption: 'è¦ä¸€èµ·å¹¸ç¦ï¼' },
    ],
    rare: [
      { image: 'æ„›å¿ƒ1.jpeg', caption: 'ç”œç”œåœˆé€ä¸ŠğŸ©ï¼' },
      { image: 'æ„›å¿ƒ2.jpeg', caption: 'æ„›å¿ƒå‚³é€ å¯¶åŒ…æ¥ï¼' },
      { image: 'æ„›å¿ƒ3.jpeg', caption: 'å¿ƒå¿ƒç›¸å°ä¸åˆ†é›¢ï¼' },
      { image: 'æ„›å¿ƒ4.jpeg', caption: 'ä½ æ˜¯æˆ‘çš„å°å¹¸é‹ğŸ€ï¼' },
      { image: 'æ„›å¿ƒ5.jpeg', caption: 'è·Ÿæˆ‘ä¸€èµ·é–ƒé–ƒç™¼å…‰ğŸ’' },
      { image: 'æ„›å¿ƒ6.jpeg', caption: 'ä½ å€‘æ˜¯æˆ‘çš„è¶…ç´šè‹±é›„ğŸ¦¸â€â™‚ï¸' },
    ],
    ultra_rare: [
      { image: 'è€¶1.jpeg', caption: 'è·Ÿæˆ‘ä¸€èµ·é–ƒé–ƒç™¼å…‰ğŸ’' },
      { image: 'è€¶2.jpeg', caption: 'ä½ æ˜¯æˆ‘çš„é–‹å¿ƒæœğŸ‰' },
      { image: 'è€¶3.jpeg', caption: 'ä»Šå¤©ä¹Ÿä¸€èµ·åŠ æ²¹å§ğŸ’–' },
      { image: 'è€¶4.jpeg', caption: 'æœ‰ä½ çœŸå¥½ï½ï½ğŸ’Œ' },
      { image: 'è€¶5.jpeg', caption: 'ä½ æ˜¯æˆ‘æœ€ç”œçš„ç³–ğŸ¬' },
      { image: 'è€¶6.jpeg', caption: 'å°ç‹—ä¾†åš•ï¼' },
      { image: 'è€¶7.jpeg', caption: 'ä½ æ˜¯æˆ‘çš„æ˜Ÿæ˜Ÿâ­' },
      { image: 'è€¶8.jpeg', caption: 'ä»Šå¤©ä¹Ÿè¦é–‹å¿ƒå”·â­' },
    ]
  };

  // é¡¯ç¤ºå¡ç‰‡å‡½å¼
  function showCard(category, index) {
    const card = cardData[category][index];
    const cardContainer = document.getElementById('card-container');
    cardContainer.style.backgroundImage = `url('/kpop_card_project/static/cards/${category}/${card.image}')`;

    const caption = document.getElementById('idol-caption');
    caption.innerText = card.caption;
  }

  // å„²å­˜æŠ½åˆ°çš„å¡ç‰‡åˆ° localStorageï¼Œä¸é‡è¤‡å­˜
  function saveCardToCollection(category, image) {
    let collection = JSON.parse(localStorage.getItem('myCollection')) || [];
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (!collection.some(c => c.category === category && c.image === image)) {
      collection.push({ category, image });
      localStorage.setItem('myCollection', JSON.stringify(collection));
    }
  }

  // éš¨æ©ŸæŠ½å¡
  function drawRandomCard(category) {
    const list = cardData[category];
    const index = Math.floor(Math.random() * list.length);
    showCard(category, index);

    // æŠ½åˆ°çš„å¡å­˜é€²æ”¶è—
    saveCardToCollection(category, list[index].image);
  }

  // æ’­æ”¾éŸ³æ•ˆï¼Œä¾é¡åˆ¥å‹•æ…‹åˆ‡æ›éŸ³æª”è·¯å¾‘
  function playSound(category) {
    const audio = document.getElementById('sound');
    audio.pause();
    audio.currentTime = 0;
    audio.src = `/kpop_card_project/static/sounds/${category}.mp3`;
    audio.play().catch(e => console.warn('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e));
  }

  // æŒ‰éˆ•äº‹ä»¶ - æŠ½å¡
  document.getElementById('summon-btn').addEventListener('click', () => {
    const categories = ['normal', 'rare', 'ultra_rare'];
    const randomCategory = categories[Math.floor(Math.random() * categories.length)];
    drawRandomCard(randomCategory);
    playSound(randomCategory);
  });

  // åˆå§‹åŒ–æ™‚é¡¯ç¤ºé è¨­å¡ç‰‡
  showCard('normal', 0);


  // MediaPipe Hands åˆå§‹åŒ–
  const videoElement = document.getElementById('webcam');
  const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
  });

  let lastTriggerTime = 0;
  function isCooldownPassed() {
    const now = Date.now();
    if (now - lastTriggerTime > 2000) {
      lastTriggerTime = now;
      return true;
    }
    return false;
  }

  hands.onResults((results) => {
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    const landmarks = results.multiHandLandmarks[0];
    const thumbTip = landmarks[4];
    const indexTip = landmarks[8];

    const dx = indexTip.x - thumbTip.x;
    const dy = indexTip.y - thumbTip.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance < 0.05 && isCooldownPassed()) {
      // éš¨æ©Ÿé¸æ“‡ä¸€å€‹é¡åˆ¥
      const categories = ['normal', 'rare', 'ultra_rare'];
      const randomCategory = categories[Math.floor(Math.random() * categories.length)];
      drawRandomCard(randomCategory);

      // æ’­æ”¾å°æ‡‰éŸ³æ•ˆ
      if (randomCategory === 'normal') {
        playSound('normal.mp3');
      } else if (randomCategory === 'rare') {
        playSound('rare.mp3');
      } else if (randomCategory === 'ultra_rare') {
        playSound('ultra_rare.mp3');
      }
    }
  }
});


  const camera = new Camera(videoElement, {
    onFrame: async () => {
      await hands.send({ image: videoElement });
    },
    width: 640,
    height: 480
  });

  camera.start();

  // Teachable Machine åˆå§‹åŒ– (æ‰‹å‹¢è¾¨è­˜)
  const URL = "https://teachablemachine.withgoogle.com/models/oVHbP_Zyv/"; // æ›æˆä½ æ¨¡å‹ç¶²å€
  let model, webcamTM, maxPredictions;

  async function initTM() {
  const modelURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";

  model = await tmImage.load(modelURL, metadataURL);
  webcamTM = new tmImage.Webcam(640, 480, true);
  await webcamTM.setup();
  await webcamTM.play();
  document.body.appendChild(webcamTM.canvas);

  maxPredictions = model.getTotalClasses();

  // åˆå§‹åŒ– MediaPipe Hands
  hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
  });

  hands.onResults(onHandsResults);

  // é–‹å§‹æŒçºŒè¾¨è­˜
  requestAnimationFrame(loop);
}

function onHandsResults(results) {
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    // OK æ‰‹å‹¢åˆ¤æ–·è·Ÿä¹‹å‰ä¸€æ¨£
    // ...
  }
}

async function loop() {
  webcamTM.update();
  await predictTM();
  await hands.send({ image: webcamTM.canvas });
  requestAnimationFrame(loop);
}


  async function loopTM() {
    webcamTM.update();
    await predictTM();
    window.requestAnimationFrame(loopTM);
  }

  let lastShown = { label: '', time: 0 };

  async function predictTM() {
  const prediction = await model.predict(webcamTM.canvas);
  prediction.sort((a, b) => b.probability - a.probability);
  const topPrediction = prediction[0];

  console.log("é æ¸¬çµæœ:", topPrediction.className, topPrediction.probability);

  if (topPrediction.probability > 0.7) {
    if (Date.now() - lastShown.time > 2000 || lastShown.label !== topPrediction.className) {
      lastShown.label = topPrediction.className;
      lastShown.time = Date.now();

      if (topPrediction.className === "Thumbs Up") {
        drawRandomCard('normal');
        playSound('normal.mp3');
      } else if (topPrediction.className === "Heart") {
        drawRandomCard('rare');
        playSound('rare.mp3');
      } else if (topPrediction.className === "Peace") {
        drawRandomCard('ultra_rare');
        playSound('ultra_rare.mp3');
      }
    }
  }
}


  function playSound(filename) {
    const audio = document.getElementById('sound');
    audio.pause();
    audio.currentTime = 0;
    audio.src = '/kpop_card_project/static/sounds/normal.mp3';
    audio.play();
  }

  // åˆå§‹åŒ– Teachable Machine
  initTM();

  // é é¢è¼‰å…¥æ™‚ï¼Œé¡¯ç¤ºé è¨­å¡ç‰‡
  showCard('normal', 0);
</script>

</body>
</html>
